<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIFU | PANEL DE CONTROL v8.2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="ai_styles.css">
    <link rel="stylesheet" href="filter_bar_sticky.css">
    <link rel="stylesheet" href="notepad.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body class="light-theme">
    <!-- Subtle Google-style background blobs -->
    <div class="bg-blob"></div>
    <div class="bg-blob secondary"></div>

    <div class="app-shell">
        <!-- Global Top Header -->
        <header class="global-header">
            <div class="header-main">
                <div class="brand">
                    <div class="logo-box">
                        <img src="img/logo sifu.png" alt="SIFU Logo"
                            style="width: 100%; height: 100%; object-fit: contain;">
                    </div>
                    <div class="brand-text">
                        <span class="brand-title">PANEL DE CONTROL</span>
                    </div>
                </div>

                <div class="global-search">
                    <div class="search-wrapper">
                        <input type="text" id="global-search-input"
                            placeholder="BUSCAR TRABAJADORA, CENTRO O SERVICIO...">
                        <button id="voice-command-btn" class="voice-btn" title="Activar Comandos de Voz">üéôÔ∏è</button>
                    </div>
                </div>

                <div class="header-comm-links">
                    <button class="comm-icon-btn wa" onclick="window.open('https://web.whatsapp.com/', '_blank')"
                        title="WhatsApp Web">
                        <span>üí¨</span>
                    </button>
                    <button class="comm-icon-btn out"
                        onclick="window.open('https://outlook.office.com/mail/', '_blank')" title="Outlook Corporativo">
                        <span>üìß</span>
                    </button>
                </div>

                <div class="header-stats">
                    <div class="h-stat-item">
                        <button class="btn-comm master" id="btn-load-master" title="Sincronizar con Excel Master">
                            <span id="sync-icon">üîÑ</span> SYNC MASTER
                        </button>
                        <span id="last-sync-time"
                            style="font-size: 8px; color: var(--text-dim); margin-top: 4px;">√öLTIMA SYNC: HOY
                            --:--</span>
                        <input type="file" id="master-file-input" style="display: none;" accept=".xlsx, .xls">
                    </div>

                    <div class="h-stat-item">
                        <div class="h-stat-label">INCIDENCIAS</div>
                        <div class="h-stat-value" id="h-stat-incidents">0</div>
                    </div>

                    <div class="h-stat-item clickable" title="Click para editar plantilla">
                        <div class="h-stat-label">OPERARIOS</div>
                        <div class="h-stat-value" id="h-stat-active">24</div>
                    </div>

                    <div class="h-stat-item">
                        <div class="h-stat-label">EFICIENCIA</div>
                        <div class="h-stat-value" id="sis-predict-val">0.0%</div>
                    </div>

                    <div class="h-stat-item">
                        <div class="h-stat-label">SATISFACCI√ìN</div>
                        <div class="h-stat-value" style="color:var(--accent-green);">9.8/10</div>
                    </div>

                    <button id="btn-situational-report" class="btn-ai-glow" onclick="openSituationalReport()">
                        <span class="ai-sparkle">üìä</span> INFORME SITUACIONAL
                    </button>
                </div>
            </div>
        </header>

        <main class="content-viewport">
            <div class="dashboard-grid">
                <!-- Sidebar Removed: User requested full expansion -->

                <!-- Operational Hub (Right) -->
                <div class="operational-hub">
                    <!-- Tabs Navigation -->
                    <nav class="tabs-nav">
                        <button class="tab-btn active" onclick="switchTab('master')">MASTER</button>
                        <button class="tab-btn" onclick="switchTab('abonos')">ABONOS (BAJAS IT)</button>
                        <button class="tab-btn" onclick="switchTab('pedidos')">PEDIDOS</button>
                        <button class="tab-btn" onclick="switchTab('descubiertos')">DESCUBIERTOS</button>
                        <button class="tab-btn" onclick="switchTab('resumen')">RESUMEN</button>
                    </nav>

                    <div class="tab-content active" id="tab-master">
                        <!-- Top Bloc de Notas (Main Task Bar) -->
                        <section class="top-notepad-section">
                            <div class="notepad-header">
                                <span class="section-tag">BLOC DE NOTAS <span class="badge blue"
                                        id="top-notes-count">0</span></span>
                                <div class="quick-note-box">
                                    <input type="text" id="quick-note-top"
                                        placeholder="A√±adir tarea r√°pida... (Enter para guardar)">
                                </div>
                            </div>
                            <div id="top-notes-feed" class="top-notes-horizontal">
                                <!-- JS Inject: Note Cards -->
                            </div>
                        </section>



                        <section class="holographic-bridge">
                            <div class="holographic-card dangerous-click" id="metric-uncovered"
                                onclick="showUncoveredDetails()">
                                <div class="hologram-effect"></div>
                                <div class="metric-orbit">
                                    <div class="orbit-ring"></div>
                                    <span class="metric-icon">üî•</span>
                                </div>
                                <div class="metric-info">
                                    <div class="metric-label">DESCUBIERTOS</div>
                                    <div class="metric-value" id="val-uncovered">0</div>
                                </div>
                            </div>
                            <div class="holographic-card info-click" id="metric-absences"
                                onclick="showAbsenceDetails()">
                                <div class="hologram-effect"></div>
                                <div class="metric-orbit">
                                    <div class="orbit-ring"></div>
                                    <span class="metric-icon">ü§í</span>
                                </div>
                                <div class="metric-info">
                                    <div class="metric-label">BAJAS / IT</div>
                                    <div class="metric-value" id="val-absences">0</div>
                                </div>
                            </div>
                            <div class="holographic-card warning-click" id="metric-incidents"
                                onclick="showIncidentDetails()">
                                <div class="hologram-effect"></div>
                                <div class="metric-orbit">
                                    <div class="orbit-ring"></div>
                                    <span class="metric-icon">‚ö†Ô∏è</span>
                                </div>
                                <div class="metric-info">
                                    <div class="metric-label">INCIDENCIAS</div>
                                    <div class="metric-value" id="val-incidents">0</div>
                                </div>
                            </div>
                            <div class="holographic-card" id="metric-active">
                                <div class="hologram-effect"></div>
                                <div class="metric-orbit">
                                    <div class="orbit-ring"></div>
                                    <span class="metric-icon">üë•</span>
                                </div>
                                <div class="metric-info">
                                    <div class="metric-label">COBERTURA</div>
                                    <div class="metric-value" id="val-active">100%</div>
                                </div>
                            </div>
                        </section>

                        <div class="modules-container">
                            <div class="module-card" id="module-master-summary">
                                <div class="master-toolbar">
                                    <div class="toolbar-left">
                                        <h3>VISTA GLOBAL DE SERVICIOS <span class="badge blue"
                                                id="master-count">0</span></h3>
                                    </div>
                                    <div class="toolbar-right">
                                        <div class="search-wrapper">
                                            <span class="search-icon">üîç</span>
                                            <input type="text" id="master-search-input"
                                                aria-label="Buscar en tabla maestra"
                                                oninput="if(typeof renderMasterBodyOnly === 'function') renderMasterBodyOnly()"
                                                placeholder="Buscar servicio, titular, centro...">
                                        </div>

                                        <!-- Dynamic Filters Area -->
                                        <div class="dynamic-filter-container">
                                            <div id="active-filters-row" class="active-filters-row">
                                                <!-- Filters injected by JS -->
                                            </div>
                                            <div class="filter-adder-wrapper">
                                                <button id="btn-add-filter" class="btn-add-filter"
                                                    onclick="toggleFilterMenu()">
                                                    ‚ûï FILTRO
                                                </button>
                                                <div id="filter-column-menu" class="filter-menu-popup">
                                                    <!-- Columns injected here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stats Summary (Fixed) -->
                                <div id="master-stats-summary" class="master-compact-stats">
                                    <!-- Dynamic Stats -->
                                </div>

                                <!-- Scrollable Content Wrapper -->
                                <div class="master-content-wrapper"
                                    style="max-height: 700px; overflow-y: auto; overflow-x: hidden;">
                                    <div id="master-summary-feed" class="scroll-feed">
                                        <!-- Table JS Inject -->
                                    </div>
                                </div>
                            </div>

                            <div class="secondary-modules">
                                <!-- RADAR DE URGENCIA -->
                                <div class="module-card" id="module-urgency-radar">
                                    <h3>üìç RADAR DE URGENCIA <span class="badge red">ACTIVO</span></h3>
                                    <div id="urgency-list" class="urgency-feed">
                                        <!-- Centros cr√≠ticos inyectados aqu√≠ -->
                                    </div>
                                </div>

                                <!-- CENTRO DE ACCI√ìN R√ÅPIDA -->
                                <div class="module-card" id="module-quick-actions">
                                    <h3>‚ö° CENTRO DE ACCI√ìN R√ÅPIDA</h3>
                                    <div class="smart-action-grid">
                                        <button class="smart-btn danger" onclick="filterByUrgency('DESCUBIERTO')">
                                            <span class="icon">üö®</span>
                                            <div class="text">
                                                <strong>DESCUBIERTOS</strong>
                                                <span>Acci√≥n Inmediata</span>
                                            </div>
                                            <span id="count-descubiertos" class="smart-badge">0</span>
                                        </button>
                                        <button class="smart-btn warning" onclick="filterByUrgency('BAJA')">
                                            <span class="icon">üè•</span>
                                            <div class="text">
                                                <strong>IT SIN SUPLENTE</strong>
                                                <span>Revisar Cobertura</span>
                                            </div>
                                            <span id="count-bajas" class="smart-badge">0</span>
                                        </button>
                                        <button class="smart-btn info" onclick="filterByUrgency('MA√ëANA')">
                                            <span class="icon">üìÖ</span>
                                            <div class="text">
                                                <strong>TERMINAN HOY/MA√ë.</strong>
                                                <span>Renovar / Buscar</span>
                                            </div>
                                            <span id="count-terminan" class="smart-badge">0</span>
                                        </button>
                                        <button class="smart-btn success" onclick="clearTableFilters()">
                                            <span class="icon">üîÑ</span>
                                            <div class="text">
                                                <strong>VISTA TOTAL</strong>
                                                <span>Limpiar Filtros</span>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="tab-content" id="tab-pedidos">
                            <section class="orders-section">
                                <div class="orders-header">
                                    <h2 class="section-title">GESTI√ìN DE PEDIDOS</h2>
                                    <div class="orders-controls">
                                        <input type="file" id="orders-file-input" accept=".xlsx" style="display:none">
                                        <button class="btn-primary" id="btn-load-orders">
                                            üìÇ CARGAR PEDIDOS
                                        </button>
                                        <div class="search-box">
                                            <input type="text" id="orders-search"
                                                placeholder="Buscar pedido, art√≠culo, c√≥digo...">
                                            <i class="fas fa-search search-icon"></i>
                                        </div>
                                    </div>
                                </div>
                                <div id="orders-table-container" class="table-container">
                                    <div class="empty-state">
                                        <p>üìÇ Carga el archivo "PLANTILLA PEDIDO" para ver los datos.</p>
                                    </div>
                                </div>
                            </section>
                        </div>

                        <div class="tab-content" id="tab-abonos">
                            <div class="module-card" id="module-absences" style="width: 100%;">
                                <h3>TRABAJADORES CON BAJA IT <span class="badge blue">LIVE</span></h3>
                                <div id="absences-feed" class="scroll-feed" style="max-height: 700px;"></div>
                            </div>
                        </div>

                        <div class="tab-content" id="tab-descubiertos">
                            <div class="module-card" id="module-uncovered" style="width: 100%;">
                                <h3>CONTROL DE DESCUBIERTOS <span class="badge red">URGENTE</span></h3>
                                <div id="uncovered-feed" class="scroll-feed" style="max-height: 700px;"></div>
                            </div>
                        </div>



                        <div class="tab-content" id="tab-resumen">
                            <div class="module-card" id="module-summary" style="width: 100%;">
                                <h3>RESUMEN EJECUTIVO DE OPERACIONES</h3>
                                <div class="analytics-row"
                                    style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-top: 20px;">
                                    <div class="analytics-card">
                                        <h4>MAPA DE CALOR DE INCIDENCIAS (√öLTIMOS 7 D√çAS)</h4>
                                        <div id="incidents-heatmap" class="heatmap-container"
                                            style="height: 250px; position: relative;">
                                            <canvas id="heatmapCanvas"></canvas>
                                        </div>
                                    </div>
                                    <div class="analytics-card">
                                        <h4>RECURRENTES / TOP ALERTAS</h4>
                                        <div id="top-incidents-list" class="heatmap-container"
                                            style="height: 250px; position: relative;">
                                            <canvas id="topClientsChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div id="notes-feed" class="scroll-feed notebook-feed" style="max-height: 250px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Hud Footer -->
        <footer class="hud-footer">
            <div id="current-date"></div>
            <div class="live-ticker">
                <span id="live-ticker-text">CARGANDO CEREBRO OPERATIVO...</span>
            </div>
            <div class="quick-input">
                <input type="text" id="quick-input-bar"
                    placeholder="COMANDO R√ÅPIDO: ESCRIBE PARA REGISTRAR INCIDENCIA...">
                <button id="voice-btn" class="voice-btn" title="Comando por Voz">üéôÔ∏è</button>
            </div>
        </footer>

    </div>

    <!-- Modals -->
    <div id="incident-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>REGISTRAR INCIDENCIA</h2>
                <button class="close-modal">√ó</button>
            </div>
            <form id="incident-form">
                <div class="form-group">
                    <label>TRABAJADORA</label>
                    <input type="text" id="worker-name" required>
                </div>
                <div class="form-group">
                    <label>TIPO</label>
                    <select id="incident-type">
                        <option value="AUSENCIA">AUSENCIA / BAJA</option>
                        <option value="RETRASO">RETRASO</option>
                        <option value="OTRO">OTRO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>PRIORIDAD</label>
                    <div class="radio-group">
                        <label><input type="radio" name="priority" value="LOW"> BAJA</label>
                        <label><input type="radio" name="priority" value="MID" checked> MEDIA</label>
                        <label><input type="radio" name="priority" value="HIGH"> ALTA</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>DESCRIPCI√ìN</label>
                    <textarea id="incident-desc"></textarea>
                </div>
                <input type="hidden" id="incident-date">
                <input type="hidden" id="incident-time">
                <button type="submit" class="btn-submit">GUARDAR EN CEREBRO</button>
            </form>
        </div>
    </div>

    <div id="note-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>NUEVA TAREA</h2>
                <button class="close-modal">√ó</button>
            </div>
            <form id="note-form">
                <textarea id="note-text" placeholder="¬øQu√© hay que hacer?" required></textarea>
                <button type="submit" class="btn-submit">A√ëADIR A AGENDA</button>
            </form>
        </div>
    </div>

    <!-- FAB -->
    <div class="fab-container">
        <div class="fab-menu" id="fab-menu">
            <button class="fab-item" id="btn-add-incident-v2" title="Informar Incidencia">üö®</button>
            <button class="fab-item" id="btn-add-note-v2" title="Nueva Tarea">üìù</button>
        </div>
        <button class="main-fab" id="main-fab">+</button>
    </div>

    <!-- Microsoft Authentication Library -->
    <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
    <script src="master_data.js"></script>
    <!-- Persistent Emergency Hub (Director View) -->
    <div id="emergency-popup-container" class="emergency-popup-fixed">
        <div class="popup-header">
            <span>üî• CENTROS DESCUBIERTOS</span>
            <button onclick="this.parentElement.parentElement.classList.toggle('minimized')">_</button>
        </div>
        <div id="emergency-list" class="popup-content">
            <!-- Dynamic Content -->
        </div>
    </div>



    <!-- Sistema de persistencia con IndexedDB (m√°s confiable que localStorage) -->
    <script src="indexeddb-persist.js"></script>
    <script src="ai_service.js"></script>
    <script src="analytics_engine.js"></script>
    <script src="app.js"></script>
    <!-- Situational Report Modal -->
    <div id="situational-report-modal" class="modal">
        <div class="modal-content report-modal-content">
            <div class="report-header">
                <div class="report-title-group">
                    <div class="report-icon">üìä</div>
                    <div>
                        <h2>INFORME DE SITUACI√ìN EN TIEMPO REAL</h2>
                        <span class="report-subtitle">AN√ÅLISIS OPERATIVO 360¬∞ | ACTUALIZADO: AHORA MISMO</span>
                    </div>
                </div>
                <button class="close-modal" onclick="closeSituationalReport()">&times;</button>
            </div>

            <div class="report-body">
                <!-- Top Metrics Row -->
                <div class="report-metrics-grid">
                    <div class="metric-card coverage">
                        <div class="metric-label">COBERTURA TOTAL</div>
                        <div class="metric-value" id="report-coverage-val">--%</div>
                        <div class="metric-trendup">Objetivo: 98%</div>
                    </div>
                    <div class="metric-card active">
                        <div class="metric-label">OPERATIVOS ACTIVOS</div>
                        <div class="metric-value" id="report-active-val">--</div>
                    </div>
                    <div class="metric-card risk">
                        <div class="metric-label">DESCUBIERTOS</div>
                        <div class="metric-value" id="report-uncovered-val">--</div>
                        <div class="metric-sub">Requiere Atenci√≥n</div>
                    </div>
                    <div class="metric-card warning">
                        <div class="metric-label">ABSENTISMO TOTAL</div>
                        <div class="metric-value" id="report-absences-val">--</div>
                        <div class="metric-sub">Bajas + IT + Vacs</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="report-charts-grid">
                    <div class="chart-container">
                        <h4>ESTADO DE LA FUERZA LABORAL</h4>
                        <div class="canvas-wrapper">
                            <canvas id="reportChartCoverage"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h4>DESGLOSE DE AUSENCIAS</h4>
                        <div class="canvas-wrapper">
                            <canvas id="reportChartAbsences"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Analysis & Action Row -->
                <div class="report-analysis-grid">
                    <div class="analysis-card hotspots">
                        <h4>üî• PUNTOS CALIENTES (HOTSPOTS)</h4>
                        <ul id="report-hotspots-list" class="report-list">
                            <!-- Injected via JS -->
                        </ul>
                    </div>
                    <div class="analysis-card actions">
                        <h4>‚ö° PLAN DE ACCI√ìN RECOMENDADO</h4>
                        <ul id="report-actions-list" class="report-list action-mode">
                            <!-- Injected via JS -->
                        </ul>
                    </div>
                </div>
            </div>

            <div class="report-footer">
                <div class="footer-info">Generado autom√°ticamente por SIFU Intelligence Engine based on Master Data.
                </div>
                <div class="footer-actions">
                    <button class="btn-report-action pdf" onclick="downloadReportPDF()">üìÑ PDF</button>
                    <button class="btn-report-action print" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button>
                    <button class="btn-report-action close" onclick="closeSituationalReport()">CERRAR INFORME</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Status Details Modal -->
    <div id="status-detail-modal" class="modal">
        <div class="status-modal-content">
            <div class="modal-header">
                <h2 id="status-modal-title">DETALLE</h2>
                <button class="close-modal" onclick="closeStatusModal()">√ó</button>
            </div>
            <div id="status-modal-body">
                <!-- Dynamic Content -->
            </div>
            <div class="status-modal-footer">
                <button class="btn-modal-action excel" onclick="exportStatusToExcel()">
                    <span>üìä</span> EXCEL
                </button>
                <button class="btn-modal-action pdf" onclick="exportStatusToPDF()">
                    <span>üìÑ</span> PDF
                </button>
                <button class="btn-modal-action back" onclick="closeStatusModal()">
                    VOLVER
                </button>
            </div>
        </div>
    </div>

    <!-- PDF Export Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Main Application -->
    <script src="indexeddb-persist.js"></script>
    <script src="master_data.js"></script>
    <script src="app.js"></script>

    <!-- Notepad Auto-Save -->
    <script src="notepad.js"></script>

</body>

</html>